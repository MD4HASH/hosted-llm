# Introduction

This repository contains terraform and ansible code that deploys an instance of the open-source AI platform [Open Webui](https://openwebui.com) in AWS.  It enables you to run any open-source LLM in your own AWS account, giving you full control over your data while leveraging scalable cloud resources. The deployment model is simple and cost-efficient: spin up a model instance on demand and destroy it when not in use.

The infrustracture contians:

- A VPC
- A regionally available autoscaling group of EC2 instances to host the service
- A load balancer to front the ALG
- Security groups configured for least access
- Dedicated SSH certificates for the instances spawned by the ALG
- terraform state hosted in s3
- A CICD pipline that is triggered on commits to this repository (WIP)

![diagram](./images/port.drawio.png)

# Deploy Instructions

- Clone this repository `git clone git@github.com:MD4HASH/portfolio.git`
- [Install terraform](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli)
- [Install AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
- navigate to `/terraform/models/prerequisites` and run `terraform init`, `terraform plan`, `terraform apply`
  - This deploys prerequisites for s3-backed terraform state and the cicd
  - This will also output the bucket name to be used for terraform state, which will be required for the next step
- navigate to `/terraform/variables.tf` and update the "allow_access_from" variable with your public IP or cidr range.  **failure to complete this step will result in the service being exposed to the public internet**.
- navigate to `/terraform` and run `terraform init`, `terraform plan`, `terraform apply`
- This will deploy the rest of the infrastructure
- The ASG contains a cloud-init script that will bootstrap the installation of ansible, clone this respository, and run the playbook located in `/ansible`, which installs and configures Open Webui.  
- When ready to decommision the environment, from the same directory, run `terraform destroy`

![terraform](./images/terraform.png)
![webui](./images/webui.png)

# Operational Instructions

- terraform will output the the dns name of the load balancer upon completion.  put this in your web browser and ensure that you specify `http` (planned improivement).  Note that it can take several minutes after the completion of terraform for the service to complete bootstrapping.
- If you want ssh access the server you can run the following command to get it's IP address

```ec2 describe-instances \
  --filters "Name=tag:aws:autoscaling:groupName,Values=webui-asg" \
  --query "Reservations[*].Instances[*].PublicIpAddress" \
  --output text
  ```

- Then, ssh with the key generated by terraform with the following command `ssh -i ../secrets/aws_admin_key.pem ubuntu@x.x.x.x`
- if you want to deploy a more powerful instance, update the `instance_size` variable in`/terraform/variables.tf` in
- If you want to use a GPU, you can open a support case in your AWS account.  But note that using a minimal GPU like `g4ad.xlarge` will cost $350~400 a month if left online.  
- in webui you can download any model from hugging face.   I reccomend trying
  - <https://huggingface.co/TheBloke/wizardLM-7B-HF>
  - <https://huggingface.co/TinyLlama/TinyLlama-1.1B-Chat-v1.0>
  - <https://huggingface.co/QuixiAI/Wizard-Vicuna-7B-Uncensored>

# Planned improvements

- front with a nginx reverse proxy and TLS certificate
- deploy wiht GPU
