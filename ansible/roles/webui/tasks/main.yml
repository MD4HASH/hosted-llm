- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

# Ensure Python 3.11 and supporting tools are available
- name: Install Python 3.11 and dependencies
  apt:
    name:
      - git
      - wget
      - curl
      - build-essential
      - libssl-dev
      - libffi-dev
      - python3.11
      - python3.11-venv
      - python3.11-dev
      - python3.11-distutils
      - python3-pip
    state: present

- name: Clone text-generation-webui repo
  git:
    repo: https://github.com/oobabooga/text-generation-webui.git
    dest: /home/ubuntu/text-generation-webui
    version: main
    force: yes
    update: yes
    accept_hostkey: yes
  become_user: ubuntu

# Ensure venv path exists cleanly
- name: Create Python venv for WebUI
  command: python3.11 -m venv /home/ubuntu/webui-venv
  args:
    creates: /home/ubuntu/webui-venv/bin/activate

- name: Upgrade pip and setuptools in venv
  pip:
    name:
      - pip
      - setuptools
      - wheel
    state: latest
    executable: /home/ubuntu/webui-venv/bin/pip

- name: Install Python requirements (AMD optimized) in venv
  pip:
    requirements: /home/ubuntu/text-generation-webui/requirements/full/requirements.txt
    executable: /home/ubuntu/webui-venv/bin/pip

- name: Create systemd service for text-generation-webui
  copy:
    dest: /etc/systemd/system/text-generation-webui.service
    content: |
      [Unit]
      Description=Text Generation WebUI
      After=network.target

      [Service]
      Type=simple
      User=ubuntu
      WorkingDirectory=/home/ubuntu/text-generation-webui
      Environment=TRANSFORMERS_ATTENTION_IMPLEMENTATION=eager
      ExecStart=/home/ubuntu/webui-venv/bin/python /home/ubuntu/text-generation-webui/server.py --listen --listen-port 7860
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd to register the service
  systemd:
    daemon_reload: yes

- name: Enable and start text-generation-webui service
  systemd:
    name: text-generation-webui
    enabled: yes
    state: started
